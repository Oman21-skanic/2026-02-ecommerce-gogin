---
import type { Session } from "../../lib/auth/session";
import { backendRequest } from "../../lib/api/backend";
import type { Cart, Order } from "../../lib/types";

interface Props {
  session?: Session | null;
}

const { session = null } = Astro.props;

let cartCount = 0;
let logsCount = 0;

if (session) {
  const cartResult = await backendRequest<Cart>("/api/v1/me/cart", {
    token: session.token,
  });

  if (cartResult.data) {
    cartCount = cartResult.data.items.reduce((acc, item) => acc + item.quantity, 0);
  }

  const ordersResult = await backendRequest<Order[]>("/api/v1/me/orders", {
    token: session.token,
  });

  if (ordersResult.data) {
    logsCount = ordersResult.data.filter((order) => {
      const status = order.status?.toLowerCase() || "";
      return status !== "failed" && status !== "done" && status !== "completed";
    }).length;
  }
}
---

<header class="site-nav sticky top-0 z-40">
  <div class="mx-auto flex max-w-7xl items-center justify-between gap-4 px-4 py-4 md:px-8">
    <a href="/" class="logo-mark" aria-label="Manscoffe">
      <span class="logo-dot"></span>
      Manscoffe
    </a>
    <nav class="hidden items-center gap-6 text-sm text-[var(--text-secondary)] md:flex">
      <a href="/" class="nav-link">Home</a>
      <a href="/products" class="nav-link">Menu</a>
      <a href="/gallery" class="nav-link">Gallery</a>
    </nav>

    <div class="flex items-center gap-3">
      <a href="/cart" class="cart-button" aria-label="Keranjang">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7">
          <path d="M6 6h14l-2 9H8L6 6Z" />
          <circle cx="9" cy="19" r="1" />
          <circle cx="17" cy="19" r="1" />
          <path d="M6 6L4 3" />
        </svg>
        <span class={`cart-badge ${cartCount > 0 ? "is-visible" : ""}`} aria-live="polite">
          {cartCount > 0 ? String(cartCount) : ""}
        </span>
      </a>
      <a href="/orders" class="nav-icon-button" aria-label="Logs Pesanan">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.7">
          <path d="M4 7h13a4 4 0 0 1 0 8H8a4 4 0 0 1-4-4V7Z" />
          <path d="M17 9h2a3 3 0 0 1 0 6h-2" />
        </svg>
        <span class={`nav-badge ${logsCount > 0 ? "is-visible" : ""}`} aria-live="polite">
          {logsCount > 0 ? String(logsCount) : ""}
        </span>
      </a>
      {session ? (
        <div class="nav-dropdown" data-dropdown>
          <button class="nav-dropdown-button" type="button" aria-haspopup="true" aria-expanded="false">
            <span class="nav-avatar">MC</span>
            Akun
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="m6 9 6 6 6-6" />
            </svg>
          </button>
          <div class="nav-dropdown-menu" role="menu">
            <a class="nav-dropdown-item" href="/orders">Logs Pesanan</a>
            <a class="nav-dropdown-item" href="/reviews">Review Saya</a>
            {session?.role === "admin" && <a class="nav-dropdown-item" href="/admin">Admin Dashboard</a>}
            <form method="POST" action="/api/auth/logout">
              <button type="submit" class="nav-dropdown-item">Keluar</button>
            </form>
          </div>
        </div>
      ) : (
        <a href="/auth/login" class="btn btn-primary btn-login">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4" />
            <path d="M10 17l5-5-5-5" />
            <path d="M15 12H3" />
          </svg>
          Masuk
        </a>
      )}
    </div>
  </div>
</header>

<script is:inline>
  const dropdown = document.querySelector("[data-dropdown]");
  const dropdownButton = dropdown?.querySelector(".nav-dropdown-button");
  const dropdownMenu = dropdown?.querySelector(".nav-dropdown-menu");

  if (dropdown && dropdownButton && dropdownMenu) {
    const closeDropdown = () => {
      dropdown.classList.remove("is-open");
      dropdownButton.setAttribute("aria-expanded", "false");
    };

    dropdownButton.addEventListener("click", () => {
      const isOpen = dropdown.classList.toggle("is-open");
      dropdownButton.setAttribute("aria-expanded", String(isOpen));
    });

    document.addEventListener("click", (event) => {
      if (!dropdown.contains(event.target)) {
        closeDropdown();
      }
    });

    document.addEventListener("keydown", (event) => {
      if (event.key === "Escape") {
        closeDropdown();
      }
    });
  }
</script>
