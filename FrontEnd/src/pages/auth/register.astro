---
import Layout from "../../layouts/Layout.astro";
import { readSession } from "../../lib/auth/session";
import { API_BASE_URL } from "../../lib/env";

const session = readSession(Astro.cookies);
const next = Astro.url.searchParams.get("next") || "/products";
const error = Astro.url.searchParams.get("error") || "";
const message = Astro.url.searchParams.get("message") || "";
const email = Astro.url.searchParams.get("email") || "";
const googleAuthUrl = `${API_BASE_URL}/api/v1/auth/google/start?next=${encodeURIComponent(next)}`;
---

<Layout title="Register Manscoffe" description="Daftar akun Manscoffe" session={session}>
  <section class="auth-page">
    <article class="auth-card">
      <h1>Buat Akun Manscoffe</h1>
      <p>Lengkapi data penting untuk pengalaman belanja lebih cepat.</p>
      {error && <p class="auth-alert auth-alert-error">{error}</p>}
      {message && <p class="auth-alert auth-alert-success">{message}</p>}

      <form method="POST" action="/api/auth/signup" class="auth-form">
        <div class="auth-row">
          <label>
            Nama Lengkap
            <input class="field" type="text" name="full_name" required />
          </label>
          <label>
            No. WhatsApp
            <input class="field" type="tel" name="phone" placeholder="08xxxxxxxxxx" required />
          </label>
        </div>
        <label>
          Email
          <input class="field" type="email" name="email" value={email} required />
        </label>
        <div class="auth-row">
          <label>
            Password
            <input class="field" type="password" name="password" required minlength="6" />
          </label>
          <label>
            Konfirmasi Password
            <input class="field" type="password" name="confirm_password" required minlength="6" />
          </label>
        </div>

        <div class="verification-box">
          <div>
            <h3>Verifikasi Akun</h3>
            <p>Masukkan OTP dari email setelah proses daftar berhasil.</p>
          </div>
        </div>

        <button class="btn btn-primary" type="submit">Daftar</button>
      </form>

      <div class="auth-divider"><span>atau</span></div>
      <a class="btn btn-ghost" href={googleAuthUrl}>
        <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
          <path fill="#EA4335" d="M12 10.2v3.9h5.4c-.2 1.1-.9 2.6-2.5 3.7l4 3.1c2.3-2.1 3.6-5.2 3.6-8.9 0-.7-.1-1.2-.2-1.8H12z"/>
          <path fill="#34A853" d="M12 22c3.2 0 5.8-1.1 7.7-2.9l-4-3.1c-1.1.7-2.5 1.2-3.7 1.2-2.8 0-5.2-1.9-6-4.6H1.9v2.9C3.8 19.8 7.6 22 12 22z"/>
          <path fill="#4A90E2" d="M6 12.6c-.2-.6-.3-1.3-.3-2s.1-1.4.3-2V5.7H1.9C1.1 7.2.6 9 .6 10.6s.5 3.4 1.3 4.9l4.1-2.9z"/>
          <path fill="#FBBC05" d="M12 4.4c1.8 0 3 .8 3.7 1.5l2.7-2.7C16.9 1.6 14.4.6 12 .6 7.6.6 3.8 2.8 1.9 5.7l4.1 2.9c.8-2.7 3.2-4.2 6-4.2z"/>
        </svg>
        Daftar dengan Google
      </a>

      <p class="auth-note">Dengan mendaftar, Anda menyetujui proses verifikasi akun.</p>
      <p class="auth-note">
        Sudah punya akun? <a href="/auth/login">Masuk</a>
      </p>

      <form method="POST" action="/api/auth/verify-otp" class="auth-form auth-verify-form">
        <label>
          Email Verifikasi
          <input class="field" type="email" name="email" value={email} required />
        </label>
        <label>
          Kode OTP
          <input class="field" type="text" name="otp" placeholder="6 digit OTP" required />
        </label>
        <button class="btn btn-primary" type="submit">Verifikasi OTP</button>
      </form>

      <form method="POST" action="/api/auth/resend-otp" class="auth-resend-form">
        <input type="hidden" name="email" value={email} />
        <button class="btn btn-ghost" type="submit">Kirim Ulang OTP</button>
      </form>
    </article>

    <aside class="auth-side">
      <div class="auth-side-card">
        <p class="auth-side-title">Coffee Club</p>
        <h2>Benefit Membership</h2>
        <ul>
          <li>Akses promo kopi dan dessert eksklusif</li>
          <li>Simpan wishlist & order history</li>
          <li>Notifikasi menu seasonal</li>
        </ul>
      </div>
      <div class="auth-side-card auth-side-image">
        <img
          src="https://images.unsplash.com/photo-1447933601403-0c6688de566e?auto=format&fit=crop&w=900&q=80"
          alt="Manscoffe bar"
          loading="lazy"
        />
        <div>
          <span>Member Only</span>
          <p>Info promo baru langsung ke email dan WhatsApp.</p>
        </div>
      </div>
    </aside>
  </section>
</Layout>
