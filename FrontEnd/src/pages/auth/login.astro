---
import Layout from "../../layouts/Layout.astro";
import { readSession } from "../../lib/auth/session";
import { API_BASE_URL } from "../../lib/env";

const session = readSession(Astro.cookies);
const next = Astro.url.searchParams.get("next") || "/products";
const error = Astro.url.searchParams.get("error") || "";
const message = Astro.url.searchParams.get("message") || "";
const email = Astro.url.searchParams.get("email") || "";
const googleAuthUrl = `${API_BASE_URL}/api/v1/auth/google/start?next=${encodeURIComponent(next)}`;
const friendlyError = error.includes("Google login gagal")
	? "Login Google gagal. Coba ulangi atau gunakan login email."
	: error;
---

<Layout title="Login Manscoffe" description="Masuk ke akun Manscoffe" session={session}>
	<section class="auth-page">
		<article class="auth-card">
			<h1>Selamat Datang Kembali</h1>
			<p>Masuk untuk melanjutkan pesanan kopi favorit Anda.</p>

			{friendlyError && <p class="auth-alert auth-alert-error">{friendlyError}</p>}
			{message && <p class="auth-alert auth-alert-success">{message}</p>}

			<form method="POST" action="/api/auth/login" class="auth-form">
				<input type="hidden" name="next" value={next} />
				<label>
					Email
					<input class="field" type="email" name="email" value={email} required />
				</label>
				<label>
					Password
					<input class="field" type="password" name="password" required minlength="6" />
				</label>
				<button class="btn btn-primary" type="submit">Login</button>
			</form>

			<div class="auth-divider"><span>atau</span></div>
			<a class="btn btn-ghost" href={googleAuthUrl}>
				<svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
					<path fill="#EA4335" d="M12 10.2v3.9h5.4c-.2 1.1-.9 2.6-2.5 3.7l4 3.1c2.3-2.1 3.6-5.2 3.6-8.9 0-.7-.1-1.2-.2-1.8H12z"/>
					<path fill="#34A853" d="M12 22c3.2 0 5.8-1.1 7.7-2.9l-4-3.1c-1.1.7-2.5 1.2-3.7 1.2-2.8 0-5.2-1.9-6-4.6H1.9v2.9C3.8 19.8 7.6 22 12 22z"/>
					<path fill="#4A90E2" d="M6 12.6c-.2-.6-.3-1.3-.3-2s.1-1.4.3-2V5.7H1.9C1.1 7.2.6 9 .6 10.6s.5 3.4 1.3 4.9l4.1-2.9z"/>
					<path fill="#FBBC05" d="M12 4.4c1.8 0 3 .8 3.7 1.5l2.7-2.7C16.9 1.6 14.4.6 12 .6 7.6.6 3.8 2.8 1.9 5.7l4.1 2.9c.8-2.7 3.2-4.2 6-4.2z"/>
				</svg>
				Masuk dengan Google
			</a>

			<div class="auth-links">
				<a href="/auth/register">Buat akun</a>
				<a href="/auth/request-reset">Lupa password?</a>
			</div>
		</article>

		<aside class="auth-photo">
			<div class="auth-photo-image">
				<img
					src="https://images.unsplash.com/photo-1501339847302-ac426a4a7cbb?auto=format&fit=crop&w=1200&q=80"
					alt="Welcome to Manscoffe"
					loading="lazy"
				/>
			</div>
			<div class="auth-photo-overlay"></div>
			<div class="auth-photo-content">
				<span>Welcome</span>
				<h2>Manscoffe Coffeehouse</h2>
				<p>Ruang hangat untuk cerita, kerja, dan kopi terbaik Nusantara.</p>
			</div>
		</aside>
	</section>
</Layout>
